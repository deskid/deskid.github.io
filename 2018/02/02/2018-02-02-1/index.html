<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="vue router 与微信分享失败">




  <meta name="keywords" content="javascript, vue, Deskid's Blog">










  <link rel="alternate" href="/atom.xml" title="Deskid's Blog">






<link rel="canonical" href="https://deskid.github.io/2018/02/02/2018-02-02-1/">



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css">




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css">



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.10.1">



  


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110544275-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110544275-1');
</script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true};
</script>

    <title> vue router 与微信分享失败 - Deskid's Blog </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Deskid's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            Tags
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            Categories
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            About
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Deskid's Blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              Home
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              Archives
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              Tags
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              Categories
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              About
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          vue router 与微信分享失败
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-02-02
        </span>
        
          <span class="post-category">
            
              <a href="/categories/Web前端/">Web前端</a>
            
          </span>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        <p>最近在接入微信分享时发现一个奇怪的现象：</p>
<p>首次分享没问题，二次分享总是失败。</p>
<a id="more"></a>
<p>具体操作如下：</p>
<ol>
<li>
<p>直接在微信扫码打开页面</p>
</li>
<li>
<p>分享 （分享正常，title、content都带上了）<br>
<img src="/media/15175660133155.jpg" alt=""></p>
</li>
<li>
<p>点击分享链接打开页面</p>
</li>
<li>
<p>二次分享 （分享失败）<br>
<img src="/media/15175660448420.jpg" alt=""></p>
</li>
</ol>
<p>首先查看官方文档，显然是JS-SDK鉴权失败导致的。</p>
<p>在微信中分享时需要先去获取JS-SDK权限验证的签名。这个签名请求的参数中就需要带上当前页面的url。</p>
<blockquote>
<p>签名生成规则如下：</p>
<p>参与签名的字段包括<strong>noncestr</strong>（随机字符串）, 有效的<strong>jsapi_ticket</strong>, <strong>timestamp</strong>（时间戳）, <strong>url</strong>（当前网页的URL，不包含#及其后面部分）。</p>
<p>对所有待签名参数按照字段名的ASCII 码从小到大排序（字典序）后，使用URL键值对的格式拼接成字符串string1。这里需要注意的是所有参数名均为小写字符。对string1作sha1加密，字段名和字段值都采用原始值，不进行URL 转义。</p>
</blockquote>
<p>而二次分享和首次分享的区别在于——<br>
分享出去的页面后面加上了类似<code>from=singlemessage</code> 、 <code>isappinstalled=1</code>的参数，在二分分享时验证JS-SDK使用的是加上了微信参数后的地址。</p>
<p>例如，我们最终分享出去的页面地址就加上了微信参数：</p>
<p><a href="http://h5.mogujie.com/pay/tthongbao_index.html?_fu=135hgdc&amp;_mgjuuid=24b0c55e-04c7-4237-8184-8024cfc468ea&amp;f=1002&amp;ptp=m1.TTiXHb.0.0.eMNdRLs&amp;shareUid=135hgdc&amp;from=groupmessage&amp;isappinstalled=1" target="_blank" rel="noopener">http://h5.mogujie.com/pay/tthongbao_index.html?_fu=135hgdc&amp;_mgjuuid=24b0c55e-04c7-4237-8184-8024cfc468ea&amp;f=1002&amp;ptp=m1.TTiXHb.0.0.eMNdRLs&amp;shareUid=135hgdc&amp;from=groupmessage&amp;isappinstalled=1</a></p>
<p>但是这不是问题的直接原因，因为我们在每次打开页面时都会动态地用当前页面的url去请求签名，这个url已经带上了微信参数。</p>
<p>那么验证失败只可能有一个原因——我们的url在获得签名后发生了改变。</p>
<p>在微信中打开页面后打印当前页面url验证一下：</p>
<p><a href="http://h5.mogujie.com/pay/tthongbao_index.html?_fu=135hgdc&amp;_mgjuuid=24b0c55e-04c7-4237-8184-8024cfc468ea&amp;f=1002&amp;from=groupmessage&amp;isappinstalled=1&amp;ptp=m1.TTiXHb.0.0.eMNdRLs&amp;shareUid=135hgdc" target="_blank" rel="noopener">http://h5.mogujie.com/pay/tthongbao_index.html?_fu=135hgdc&amp;_mgjuuid=24b0c55e-04c7-4237-8184-8024cfc468ea&amp;f=1002&amp;from=groupmessage&amp;isappinstalled=1&amp;ptp=m1.TTiXHb.0.0.eMNdRLs&amp;shareUid=135hgdc</a></p>
<p>发现页面地址真的变了。这里注意到 <code>query string</code> 按照 key 的字母顺序重排了。这个重排动作并不是浏览器做的，因为当我访问别的活动页地址时，并不会有这样的重排。</p>
<p>观察到重排现象后，我开始怀疑vue-router了。果然在issue列表中找到了<a href="https://github.com/vuejs/vue-router/issues/926" target="_blank" rel="noopener">issues-926</a>(看到掉进坑里的不止我一个，莫名其妙的开心了起来)。</p>
<p>按照 vue-router 的 release log ，在 <a href="https://github.com/vuejs/vue-router/releases/tag/v2.1.0" target="_blank" rel="noopener">2.1.0</a> 版本的<code>stringifyQuery</code>函数中已经去掉了sort动作。</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">export function stringifyQuery (obj: Dictionary&lt;string&gt;): string &#123;	</span><br><span class="line"><span class="deletion">-  const res = obj ? Object.keys(obj).sort().map(key =&gt; &#123;</span></span><br><span class="line"><span class="addition">+  const res = obj ? Object.keys(obj).map(key =&gt; &#123;</span></span><br><span class="line">      const val = obj[key]</span><br><span class="line">  		  </span><br><span class="line">      if (val <span class="comment">=== undefined) &#123;</span></span><br></pre></td></tr></table></figure>
<p>升级到最新版本后再次测试果然二次分享ok了。</p>
<hr>
<p>然而这里的坑并没有结束，只是被隐藏的更深了。</p>
<p><code>vue-router</code> 在 <code>parseQuery</code> 时将 query 字符串构造为一个字典对象；然后在 history.pushState 时再将这个字典对象<code>stringifyQuery</code>转化为一个 queryString 字符串。</p>
<p>在序列化和反序列化的过程中，最重要的是保持前后的信息一致。</p>
<p><code>vue-router</code> 2.1.0 之前的版本由于对<code>Object.keys(obj)</code>进行<code>sort</code>导致了顺序信息的丢失，引起序列化前后地址不一致。<br>
那么去掉了<code>sort</code>操作后的<code>vue-router</code>能还原顺序信息了吗？</p>
<p>99%的情况下可以，除非 query 中带有 Array 类型的 value…</p>
<p>举例说明：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?foo=bar&amp;baz=qux&amp;foo=bla</span><br></pre></td></tr></table></figure>
<p>经过<code>vue-router</code> 的<code>parseQuery</code>后，变成了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  foo: [bar,bla],</span><br><span class="line">  baz: qux</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里转化没问题，再通过 <code>stringifyQuery</code> 转为字符串呢，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">?foo=bar&amp;foo=bla&amp;baz=qux</span><br></pre></td></tr></table></figure>
<p>地址又变了！</p>
<p>拿<a href="https://url.spec.whatwg.org/#urlsearchparams" target="_blank" rel="noopener">标准实现</a> <code>URLSearchParams</code> 测试一下就会发现：在<code>URLSearchParams</code>上调用<code>toString</code>不会改变原来的queryString顺序：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var paramsString = &quot;foo=bar&amp;baz=qux&amp;foo=bala&quot;;</span><br><span class="line">var searchParams = new URLSearchParams(paramsString);</span><br><span class="line"></span><br><span class="line">for (let p of searchParams) &#123;</span><br><span class="line">  console.log(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">searchParams.toString();</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(2) [&quot;foo&quot;, &quot;bar&quot;]</span><br><span class="line">(2) [&quot;baz&quot;, &quot;qux&quot;]</span><br><span class="line">(2) [&quot;foo&quot;, &quot;bala&quot;]</span><br><span class="line">&quot;foo=bar&amp;baz=qux&amp;foo=bala&quot;</span><br></pre></td></tr></table></figure>
<p>而在vue-router内部，<code>parseQuery</code>在遇到重复的<code>key</code>时，会把字典中原有的value转化为数组，再将新的 value push到数组尾部。这里不可避免的丢失了<code>key</code>数组原来出现在url中的顺序。</p>
<p>归根结底，还是数据结构选取的锅：<code>parseQuery</code>生成的对象应该是一个 key-value 组成的<code>pair list</code>而不是<code>dictionary</code>。</p>
<p>找到思路了，vue-router源码也是现成的，那就改吧。</p>
<p>由于 query 对象是通过<code>$router</code>对外暴露的，直接改<code>parseQuery</code>的返回值类型代价太大了。我的思路是给 query 对象增加一个属性。</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">function parseQuery (query: string): Dictionary&lt;string&gt; &#123;</span><br><span class="line">  const res = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+  Object.defineProperty(res, '_rawQuery', &#123;</span></span><br><span class="line"><span class="addition">+    value: [],</span></span><br><span class="line"><span class="addition">+    enumerable: false</span></span><br><span class="line"><span class="addition">+  &#125;)</span></span><br><span class="line"></span><br><span class="line">  query = query.trim().replace(/^(\?|#|&amp;)/, '')</span><br><span class="line"></span><br><span class="line">  if (!query) &#123;</span><br><span class="line">    return res</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="deletion">-  query.split('&amp;').forEach((param) =&gt; &#123;</span></span><br><span class="line"><span class="addition">+  query.split('&amp;').forEach((param, index) =&gt; &#123;</span></span><br><span class="line">    const parts = param.replace(/\+/g, ' ').split('=')</span><br><span class="line">    const key = decode(parts.shift())</span><br><span class="line">    const val = parts.length &gt; 0</span><br><span class="line">      ? decode(parts.join('='))</span><br><span class="line">      : null</span><br><span class="line"></span><br><span class="line"><span class="addition">+    if (res._rawQuery[index] === undefined) &#123;</span></span><br><span class="line"><span class="addition">+      res._rawQuery[index] = []</span></span><br><span class="line"><span class="addition">+      res._rawQuery[index][0] = key</span></span><br><span class="line"><span class="addition">+      res._rawQuery[index][1] = val</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (res[key] <span class="comment">=== undefined) &#123;</span></span><br><span class="line">      res[key] = val</span><br><span class="line">    &#125; else if (Array.isArray(res[key])) &#123;</span><br><span class="line">      res[key].push(val)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      res[key] = [res[key], val]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  return res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>parseQuery()</code>函数中额外添加<code>_rawQuery</code>数组属性，为了简单，这里使用了二维数组来模拟pair。按照<code>queryString</code> key-value 出现的顺序初始化数组。注意：为了不影响原来对Component暴露的query对象，特地将<code>_rawQuery</code>的<code>enumerable</code>置为false。</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">export function stringifyQuery (obj: Dictionary&lt;string&gt;): string &#123;</span><br><span class="line"><span class="addition">+  const hasRawQuery = !!obj._rawQuery</span></span><br><span class="line"><span class="addition">+  const queryObj = hasRawQuery ? obj._rawQuery : obj</span></span><br><span class="line"><span class="deletion">-  const res = obj ? Object.keys(obj).map(key =&gt; &#123;</span></span><br><span class="line"><span class="addition">+  const res = queryObj ? Object.keys(queryObj).map(index =&gt; &#123;</span></span><br><span class="line"><span class="addition">+   const key = hasRawQuery ? queryObj[index][0] : index</span></span><br><span class="line"><span class="deletion">-   const val = obj[key]</span></span><br><span class="line"><span class="addition">+   const val = hasRawQuery ? queryObj[index][1] : obj[index]</span></span><br><span class="line"></span><br><span class="line">    if (val <span class="comment">=== undefined) &#123;</span></span><br><span class="line">      return ''</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (val <span class="comment">=== null) &#123;</span></span><br><span class="line">      return encode(key)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (Array.isArray(val)) &#123;</span><br><span class="line">      const result = []</span><br><span class="line">      val.forEach(val2 =&gt; &#123;</span><br><span class="line">        if (val2 <span class="comment">=== undefined) &#123;</span></span><br><span class="line">          return</span><br><span class="line">        &#125;</span><br><span class="line">        if (val2 <span class="comment">=== null) &#123;</span></span><br><span class="line">          result.push(encode(key))</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          result.push(encode(key) + '=' + encode(val2))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      return result.join('&amp;')</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return encode(key) + '=' + encode(val)</span><br><span class="line">  &#125;).filter(x =&gt; x.length &gt; 0).join('&amp;') : null</span><br><span class="line">  return res ? `?$&#123;res&#125;` : ''</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>stringifyQuery()</code>函数中先判断是否有<code>_rawQuery</code>，有的话优先用<code>_rawQuery</code>。其余操作一致。</p>
<p>改完后，跑一遍vue-router单元测试。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm run test:unit</span><br><span class="line"></span><br><span class="line">Started</span><br><span class="line">................................................................</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">64 specs, 0 failures</span><br><span class="line">Finished in 0.3 seconds</span><br></pre></td></tr></table></figure>
<p>测试通过，浏览器中的<code>?foo=bar&amp;baz=qux&amp;foo=bla</code>顺序也保留下来了，完美。</p>
<p>总结：</p>
<ol>
<li>query string 本身只是键值对，是顺序无关的，w3c规范也没有强调说一定要符合特定的顺序。vue-router 2.1.0之前的版本的<code>sort</code>操作纯属画蛇添足。最好的做法是保留原有的顺序信息，把问题抛到framework外部去解决。</li>
<li>微信js-sdk的签名接口设计的不合理：只考虑了key排序的问题，而忽视了作为value的url的排序问题。由于url query参数的顺序不影响url的相等性，在计算签名时应该在接口内部对url的query进行排序操作。</li>
</ol>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>Author: </span>
      <a href="https://deskid.github.io">deskid</a>
    </p>
    <p class="copyright-item">
      <span>Link: </span>
      <a href="https://deskid.github.io/2018/02/02/2018-02-02-1/">https://deskid.github.io/2018/02/02/2018-02-02-1/</a>
    </p>
    <p class="copyright-item">
      <span>License: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/javascript/">javascript</a>
            
              <a href="/tags/vue/">vue</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2018/04/02/h5-debug/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">iOS 和 Android 真机调试</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2017/12/08/throttle-vs-debounce/">
        <span class="next-text nav-default">throttle 和 debounce</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:deskidzhou@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/deskid" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>



<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2019

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">deskid</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://deskid.github.io/2018/02/02/2018-02-02-1/';
        this.page.identifier = '2018/02/02/2018-02-02-1/';
        this.page.title = 'vue router 与微信分享失败';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//deskid.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>

  

  



    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.10.1"></script>

  </body>
</html>
